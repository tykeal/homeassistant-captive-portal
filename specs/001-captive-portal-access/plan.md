SPDX-FileCopyrightText: 2025 Andrew Grimberg
SPDX-License-Identifier: Apache-2.0

# Implementation Plan: Captive Portal Guest Access

**Branch**: `001-captive-portal-access` | **Date**: 2025-10-22 | **Spec**: ./spec.md | **Phase1**: ./phase1.md
**Input**: Feature specification from `/specs/001-captive-portal-access/spec.md`

## Summary

Implement a pluggable captive portal enabling rental guest network access with voucher validation, administrative grant management, Home Assistant entity mapping, and TP-Omada controller integration. Deliver as a Home Assistant addon but runnable standalone (container) with consistent configuration.

## Technical Context

**Language/Version**: Python 3.13
**Primary Dependencies**: FastAPI (HTTP/API & admin UI simple templating), Jinja2 (theming templates), httpx (async HTTP to TP-Omada + HA REST), SQLModel (initial SQLite persistence), passlib/bcrypt (password hashing), pydantic (data validation), uv (package/environment manager), alembic (for future DB migrations if upgraded beyond SQLite)
**Storage**: Adopt SQLite via SQLModel behind a repository abstraction (Clarification Q1). Future upgrade path to PostgreSQL documented; no multi-instance requirement in v1.
**Testing**: pytest + pytest-asyncio; coverage enforcement; contract tests for controller API boundaries using recorded fixtures; integration tests spinning up FastAPI test client.
**Target Platform**: Home Assistant addon container (based on addons-example best practices) & generic OCI container (Docker/Podman)
**Project Type**: Single backend project (web portal + API) with minimal frontend templating (no SPA framework initially)
**Performance Baselines (p95 unless noted)**:
- Voucher redemption: ≤800ms (L1: 50 concurrent) / ≤900ms (L2: 200 concurrent)
- Auth login API: ≤300ms; Controller propagation (authorize→active): ≤25s; Admin grants list (500 grants): ≤1500ms
- Memory RSS: ≤150MB; CPU 1-min peak: ≤60% @ 200 concurrent; Merge gate: >10% regression vs baseline blocks
- Non-blocking IO (async); bandwidth shaping delegated to controller
**Scale/Scope**: Single property initial; design for extension to multiple controllers and properties (multi-tenancy deferred). Concurrent guests <50 typical; admin users <5.

## Constitution Check

Refer to `constitution_gate_checklist.md` for per-phase gate verification (introduced Phase 0, task T0009).

Gates derived from constitution:
- Atomic commits: Plan phases enforce granular task breakdown.
- SPDX headers: Template enforcement; automation script will insert headers for new files.
- TDD: Tests defined per phase before implementation tasks start (see Phases below).
- Performance baselines: SC-001..SC-003 mapped to test scaffolds; TODO(PERFORMANCE_BASELINES) remains for precise p95 thresholds.
- Pre-commit integrity: Add pre-commit config (ruff/black/pytest/REUSE, etc.) in Phase 0.
Status: All gates feasible; outstanding TODO: finalize storage engine decision & baseline numeric performance thresholds.

## Project Structure

### Documentation (this feature)

```text
specs/001-captive-portal-access/
├── plan.md
├── research.md            # Phase 0: controller API + HA API exploration
├── data-model.md          # Phase 1: ERD and entity definitions
├── quickstart.md          # Phase 1: install/run usage (addon + container)
├── contracts/             # Phase 1: API + controller interaction contracts
└── tasks.md               # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── core/                  # Core domain logic (entities, repositories)
├── controllers/           # Pluggable backend controllers (tp_omada/, base.py)
├── services/              # Business services (voucher_service.py, grant_service.py)
├── api/                   # FastAPI routers (auth.py, vouchers.py, grants.py, admin.py, mapping.py)
├── web/                   # Jinja2 templates & static assets (themes/ default/)
├── security/              # Password hashing, auth utils
├── persistence/           # DB session, migration hooks, storage abstraction
└── config/                # Settings, environment parsing

tests/
├── unit/
├── contract/              # Controller & HA API contract tests (mocked/fixture responses)
├── integration/           # FastAPI app end-to-end flows
└── performance/           # Benchmark scaffolds (later)
```

**Structure Decision**: Single backend project with modular directories; avoids premature multi-project complexity while enabling future controller additions via `controllers/` pluggable pattern.

## Phase Breakdown & TDD Sequencing

### Phase 0: Research & Environment Setup
Deliverables: research.md, initial pre-commit config, dependency selection, controller API analysis summary (mapping of needed endpoints), HA REST entity discovery notes.
Tests (author first): None functional yet; add placeholder performance baseline test scaffolds (skipped) and config loading unit tests.
Constitution Gate Re-check: Verify SPDX headers on new files, pre-commit active, TDD scaffolds present.

### Phase 1: Data Model & Contracts
Deliverables: data-model.md (Voucher, AccessGrant, AdminAccount, EntityMapping, AuditLog models), contracts/ (OpenAPI draft for internal API, JSON schema for voucher redemption request/response, controller interaction contract stubs).
Tests first: unit tests for model validation (pydantic), contract tests using mocked controller responses; negative tests for duplicate voucher race condition simulation.
Constitution Gate Re-check: Confirm all new files have SPDX headers, tests exist before implementation, atomic commit sequencing followed.

### Phase 2: Core Services (Voucher & Grant Logic)
Implement voucher creation, redemption flow, grant lifecycle (create/update/revoke), duplicate prevention semaphore/locking strategy.
Tests first: service-level unit tests (voucher expiration, grant extension), concurrency test for duplicate redemption.
Constitution Gate Re-check: Ensure tests failing before code, validate no pre-commit bypass, verify audit/logging tasks planned.

### Phase 3: Controller Integration (HA + TP-Omada)
Implement HA integration (REST client, 60s polling, Rental Control event processing) + TP-Omada adapter (external portal API, retry queue). Includes models for HAIntegrationConfig (auth attribute selection, grace period), RentalControlEvent (caching), CleanupService (7-day retention), and BookingCodeValidator (case-insensitive matching).
Tests first: HA client tests (mocked REST), poller tests (60s + backoff), event processing tests (attribute selection/fallback), TP-Omada contract tests (fixture responses), cleanup tests (retention policy), case-insensitive booking code matching tests.
Backend-only (Decision D11): REST API endpoints for integration management and booking authorization; UI deferred to Phase 4.
Constitution Gate Re-check: Confirm adapter tests cover error paths (retry), HA unavailability tests (backoff), metrics instrumentation test present before implementation, migration tests for schema changes.

### Phase 4: Admin Web Interface & Theming
Constitution Gate Re-check: Validate security headers, CSRF tests precede implementation, theme precedence test (remediation) added before UI changes.
Implement authentication (secure HTTP-only server-side session cookies + CSRF protection using argon2 password hashing per D13), admin CRUD for vouchers/grants, entity mapping UI, theming loader.
Session Management (D12): Server-side session cookies (HTTP-only, Secure, SameSite=Strict) with configurable lifetimes (default 30 min idle, 8 hr absolute per D17).
CSRF Protection (D14): Double-submit cookie pattern (stateless, 32-byte random token).
Admin UI Theme (D15): Minimal CSS (no framework) for smaller bundle, modern CSS features (grid, flexbox, CSS variables).
Guest Portal Theming (D16): CSS variable overrides (admin-configurable colors, logo) stored in GuestPortalTheme model; deferred UI to Phase 5.
Includes deferred Phase 3 UI (Decision D11): HA integration configuration forms, guest booking code authorization form, enhanced grants display.
Tests first: integration tests for admin routes (auth success/failure), CSRF enforcement tests, session timeout tests (idle + absolute), template rendering checks (no sensitive data leakage), UI tests for booking code forms and integration management.
Decisions reference: See phase4_decisions.md for full rationale on D12-D17 (all approved 2025-10-27T00:45:00Z).

### Phase 5: Guest Portal & Authentication
Constitution Gate Re-check: Confirm booking code validation tests cover all FR-018 error scenarios (invalid_format, not_found, outside_window, duplicate, integration_unavailable), metrics tests present, audit logging tests present, rate limiting tests present, redirect validation tests present.
Guest-facing captive portal with unified authorization form (voucher + booking code), rate limiting, post-authentication redirect handling, and checkout grace period support.
Authorization Form Access (D18): Both direct URL (`/guest/authorize`) and captive portal detection redirects (covers all guest arrival paths).
Unified Input Field (D19): Single code input field, backend auto-detects voucher vs booking code; booking codes case-insensitive match, case-sensitive storage.
Rate Limiting (D20): Admin-configurable per-IP rate limiting (default 5 attempts/minute) to prevent brute-force attacks.
Post-Auth Redirect (D21): Admin-configurable redirect behavior, default to original destination URL with fallback to success page.
Grace Period (D22): Admin-configurable checkout grace period (default 15 min, max 30 min) extends booking access post-checkout.
Tests first: unified authorization form tests (voucher/booking detection), rate limiting enforcement tests, redirect validation tests (whitelist, open redirect prevention), grace period calculation tests, captive portal detection redirect tests, end-to-end guest flow tests.
Decisions reference: See phase5_decisions.md for full rationale on D18-D22 (all approved 2025-10-29T18:42:00Z).

### Phase 6: Performance & Hardening
Constitution Gate Re-check: Finalize performance baselines before removing test skips; enforce audit/log completeness tests present.
Add benchmark tests for voucher redemption path, log audit completeness tests, finalize performance baseline numbers.
Refactor for any identified bottlenecks.

### Phase 7: Polish & Documentation
Constitution Gate Re-check: Ensure documentation reflects final baselines, all SPDX headers verified, no skipped tests remain.
quickstart.md, finalize README additions, audit logging review, ensure all SPDX headers, license compliance review, addon build artifacts (Dockerfile, config.json) aligned with addons-example.
Tests: finalize performance threshold assertions (remove skips), documentation validation (lint).

## Role-Based Access Control (FR-017)

FR-017: System SHALL enforce role-based permissions: {Viewer: read dashboards only; Operator: viewer + trigger captive session resets; Admin: operator + manage vouchers/roles; Auditor: viewer + access immutable logs}. No other actions permitted (deny-by-default). Permission matrix documented and tests (authorization allow/deny, negative) precede implementation.

## Booking Identifier Validation (FR-018)

FR-018: System SHALL validate guest authorization (booking) codes against Rental Control events.
- Source Entities per integration: calendar.rental_control_<integration_id>, sensor.rental_control_<integration_id>_event_[0..N-1].
- Polling: Phase 3 poller fetches all configured integrations every 60s; exponential backoff on HA unavailability (Decision D6).
- Event Cache: RentalControlEvent model stores events for 7 days post-checkout (Decision D8); daily 3 AM cleanup.
- Prioritized Events: event 0 (current or checking-out today), event 1 (upcoming/arriving today). All events 0..N-1 are eligible if within [start, end + grace_period].
- Candidate Identifier Attributes: slot_code (default), slot_name, or last_four (admin-selectable per integration via HAIntegrationConfig.auth_attribute, Decision D7). Admin chooses once per integration; selection persisted. Fallback logic: configured → slot_code → slot_name → skip event.
- Grace Period: Checkout grace period extends end_utc by 0-30 minutes (default 15, configurable via HAIntegrationConfig.checkout_grace_minutes, Decision D9).
- Formats: slot_code regex ^\d{4,}$; last_four regex ^\d{4}$; slot_name treated as opaque string (non-empty, trimmed, <=128 chars).
- Guest Input: Single authorization code field (no username).
- Case Sensitivity: Matching case-INSENSITIVE for guest input (D10); storage and display case-SENSITIVE (preserve original from Rental Control for admin cross-reference).
- Validation Window: Access allowed from event.start (floored to minute) until event.end + grace_period (ceiled to minute). Access grants lifetime resolved to minute boundaries.
- Devices: Unlimited devices per valid booking within window.
- Failure Responses: 400 invalid format; 404 booking not found; 410 booking outside active window; 409 duplicate active grant (same code already redeemed and still valid) returns existing grant reference.
- Metrics: booking_lookup_latency (histogram), validation_fail_total (counter with reason labels: invalid_format, not_found, outside_window, duplicate, integration_unavailable), ha_polling_errors (counter).
- Audit Log: booking_code_attempt (code_hash, integration_id, outcome, reason, correlation_id), event.cleanup (deleted_count), ha_polling_failure (integration_id, backoff_seconds).
- Future: Bandwidth limits & guest upgrade path (deferred; note for roadmap).
- Security: Deny-by-default if integration selection missing or events unavailable (reason: integration_unavailable).

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|---------------------------------------|
| Async architecture | Needed for non-blocking controller/HA calls | Sync IO would raise latency & block scaling |
| Pluggable controllers dir | Future multi-controller support | Single file adapter would become monolith |

## Initial Task Seeds (High-Level)
(Details deferred to /speckit.tasks)
- Setup uv project, pyproject.toml, add dependencies
- Add addon skeleton (Dockerfile, config.json, run script) based on home-assistant/addons-example
- Add pre-commit config (ruff, reuse, pytest, black if used)
- research.md: summarize TP-Omada endpoints (login, authorize, revoke) & HA entity endpoints
- data-model.md: define entities & relationships
- contracts/: define OpenAPI routers & controller interface spec
- Implement persistence abstraction + SQLite default (repository pattern)
- Voucher service + tests (create, validate, prevent duplicates)
- Grant service + tests (create, extend, revoke, audit logging)
- Controller adapter (tp_omada) + contract tests
- Admin auth (password hashing, secure HTTP-only session cookies + CSRF) + tests
- Web templates (portal page, admin dashboard) basic theme config
- HA mapping integration logic + tests
- Performance scaffolds (benchmark voucher redemption)

## Open Questions (Resolved Clarifications Applied)
1. Storage choice: RESOLVED → SQLite via SQLModel behind abstraction (Q1)
2. Admin auth mechanism: RESOLVED → Secure HTTP-only server-side session cookies + CSRF protection (Q2)

## Risk & Mitigation
- Controller API instability: Implement resilient retry with capped exponential backoff.
- Race conditions on voucher redemption: Use DB uniqueness + async lock.
- HA API latency/unavailability: Cache entity mapping, degrade gracefully.
- Performance regression risk: Add benchmark early Phase 6 before polish.

## Next Steps
Proceed to Phase 0 tasks ensuring test placeholders created before service logic. After Phase 1 completion run constitution re-check (coverage, TDD adherence, performance baseline TODOs tracked).
