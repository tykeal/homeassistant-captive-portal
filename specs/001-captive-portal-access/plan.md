SPDX-FileCopyrightText: 2025 Andrew Grimberg
SPDX-License-Identifier: Apache-2.0

# Implementation Plan: Captive Portal Guest Access

**Branch**: `001-captive-portal-access` | **Date**: 2025-10-22 | **Spec**: ./spec.md
**Input**: Feature specification from `/specs/001-captive-portal-access/spec.md`

## Summary

Implement a pluggable captive portal enabling rental guest network access with voucher validation, administrative grant management, Home Assistant entity mapping, and TP-Omada controller integration. Deliver as a Home Assistant addon but runnable standalone (container) with consistent configuration.

## Technical Context

**Language/Version**: Python 3.13
**Primary Dependencies**: FastAPI (HTTP/API & admin UI simple templating), Jinja2 (theming templates), httpx (async HTTP to TP-Omada + HA REST), SQLModel (initial SQLite persistence), passlib/bcrypt (password hashing), pydantic (data validation), uv (package/environment manager), alembic (for future DB migrations if upgraded beyond SQLite)
**Storage**: Adopt SQLite via SQLModel behind a repository abstraction (Clarification Q1). Future upgrade path to PostgreSQL documented; no multi-instance requirement in v1.
**Testing**: pytest + pytest-asyncio; coverage enforcement; contract tests for controller API boundaries using recorded fixtures; integration tests spinning up FastAPI test client.
**Target Platform**: Home Assistant addon container (based on addons-example best practices) & generic OCI container (Docker/Podman)
**Project Type**: Single backend project (web portal + API) with minimal frontend templating (no SPA framework initially)
**Performance Goals**: Voucher redemption end-to-end < 1s median; admin list grants page loads < 2s with up to 500 grants; controller update propagation <30s (spec success criteria) with retry resolution <2min worst-case.
**Constraints**: p95 voucher redemption <2s; memory footprint <150MB RSS; CPU utilization idle <5%; No blocking IO in request handlers (async everywhere). Bandwidth shaping configuration delegated to controller (not enforced in app).
**Scale/Scope**: Single property initial; design for extension to multiple controllers and properties (multi-tenancy deferred). Concurrent guests <50 typical; admin users <5.

## Constitution Check

Gates derived from constitution:
- Atomic commits: Plan phases enforce granular task breakdown.
- SPDX headers: Template enforcement; automation script will insert headers for new files.
- TDD: Tests defined per phase before implementation tasks start (see Phases below).
- Performance baselines: SC-001..SC-003 mapped to test scaffolds; TODO(PERFORMANCE_BASELINES) remains for precise p95 thresholds.
- Pre-commit integrity: Add pre-commit config (ruff/black/pytest/REUSE, etc.) in Phase 0.
Status: All gates feasible; outstanding TODO: finalize storage engine decision & baseline numeric performance thresholds.

## Project Structure

### Documentation (this feature)

```text
specs/001-captive-portal-access/
├── plan.md
├── research.md            # Phase 0: controller API + HA API exploration
├── data-model.md          # Phase 1: ERD and entity definitions
├── quickstart.md          # Phase 1: install/run usage (addon + container)
├── contracts/             # Phase 1: API + controller interaction contracts
└── tasks.md               # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── core/                  # Core domain logic (entities, repositories)
├── controllers/           # Pluggable backend controllers (tp_omada/, base.py)
├── services/              # Business services (voucher_service.py, grant_service.py)
├── api/                   # FastAPI routers (auth.py, vouchers.py, grants.py, admin.py, mapping.py)
├── web/                   # Jinja2 templates & static assets (themes/ default/)
├── security/              # Password hashing, auth utils
├── persistence/           # DB session, migration hooks, storage abstraction
└── config/                # Settings, environment parsing

tests/
├── unit/
├── contract/              # Controller & HA API contract tests (mocked/fixture responses)
├── integration/           # FastAPI app end-to-end flows
└── performance/           # Benchmark scaffolds (later)
```

**Structure Decision**: Single backend project with modular directories; avoids premature multi-project complexity while enabling future controller additions via `controllers/` pluggable pattern.

## Phase Breakdown & TDD Sequencing

### Phase 0: Research & Environment Setup
Deliverables: research.md, initial pre-commit config, dependency selection, controller API analysis summary (mapping of needed endpoints), HA REST entity discovery notes.
Tests (author first): None functional yet; add placeholder performance baseline test scaffolds (skipped) and config loading unit tests.

### Phase 1: Data Model & Contracts
Deliverables: data-model.md (Voucher, AccessGrant, AdminAccount, EntityMapping, AuditLog models), contracts/ (OpenAPI draft for internal API, JSON schema for voucher redemption request/response, controller interaction contract stubs).
Tests first: unit tests for model validation (pydantic), contract tests using mocked controller responses; negative tests for duplicate voucher race condition simulation.

### Phase 2: Core Services (Voucher & Grant Logic)
Implement voucher creation, redemption flow, grant lifecycle (create/update/revoke), duplicate prevention semaphore/locking strategy.
Tests first: service-level unit tests (voucher expiration, grant extension), concurrency test for duplicate redemption.

### Phase 3: Controller Integration (TP-Omada)
Implement adapter for TP-Omada external portal API interactions; retry queue for failures.
Tests first: contract tests with fixture responses; integration tests verifying grant propagation statuses.

### Phase 4: Admin Web Interface & Theming
Implement authentication (secure HTTP-only server-side session cookies + CSRF protection), admin CRUD for vouchers/grants, entity mapping UI, theming loader.
Tests first: integration tests for admin routes (auth success/failure), CSRF enforcement tests, template rendering checks (no sensitive data leakage).

### Phase 5: Home Assistant Entity Mapping Integration
Polling or on-demand fetch of Rental Control entities; persistence of selected mapping; usage in authorization decisions.
Tests first: integration tests with mocked HA responses, mapping save/retrieve, fallback when HA unavailable.

### Phase 6: Performance & Hardening
Add benchmark tests for voucher redemption path, log audit completeness tests, finalize performance baseline numbers.
Refactor for any identified bottlenecks.

### Phase 7: Polish & Documentation
quickstart.md, finalize README additions, audit logging review, ensure all SPDX headers, license compliance review, addon build artifacts (Dockerfile, config.json) aligned with addons-example.
Tests: finalize performance threshold assertions (remove skips), documentation validation (lint).

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|---------------------------------------|
| Async architecture | Needed for non-blocking controller/HA calls | Sync IO would raise latency & block scaling |
| Pluggable controllers dir | Future multi-controller support | Single file adapter would become monolith |

## Initial Task Seeds (High-Level)
(Details deferred to /speckit.tasks)
- Setup uv project, pyproject.toml, add dependencies
- Add addon skeleton (Dockerfile, config.json, run script) based on home-assistant/addons-example
- Add pre-commit config (ruff, reuse, pytest, black if used)
- research.md: summarize TP-Omada endpoints (login, authorize, revoke) & HA entity endpoints
- data-model.md: define entities & relationships
- contracts/: define OpenAPI routers & controller interface spec
- Implement persistence abstraction + SQLite default (repository pattern)
- Voucher service + tests (create, validate, prevent duplicates)
- Grant service + tests (create, extend, revoke, audit logging)
- Controller adapter (tp_omada) + contract tests
- Admin auth (password hashing, secure HTTP-only session cookies + CSRF) + tests
- Web templates (portal page, admin dashboard) basic theme config
- HA mapping integration logic + tests
- Performance scaffolds (benchmark voucher redemption)

## Open Questions (Resolved Clarifications Applied)
1. Storage choice: RESOLVED → SQLite via SQLModel behind abstraction (Q1)
2. Admin auth mechanism: RESOLVED → Secure HTTP-only server-side session cookies + CSRF protection (Q2)

## Risk & Mitigation
- Controller API instability: Implement resilient retry with capped exponential backoff.
- Race conditions on voucher redemption: Use DB uniqueness + async lock.
- HA API latency/unavailability: Cache entity mapping, degrade gracefully.
- Performance regression risk: Add benchmark early Phase 6 before polish.

## Next Steps
Proceed to Phase 0 tasks ensuring test placeholders created before service logic. After Phase 1 completion run constitution re-check (coverage, TDD adherence, performance baseline TODOs tracked).
